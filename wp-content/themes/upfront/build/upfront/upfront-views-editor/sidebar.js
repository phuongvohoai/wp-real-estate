!function(e){var n=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/sidebar/sidebar-panel","scripts/upfront/upfront-views-editor/sidebar/draggable-element","scripts/upfront/upfront-views-editor/commands","scripts/upfront/upfront-views-editor/sidebar/sidebar-profile","scripts/upfront/upfront-views-editor/sidebar/sidebar-panels","scripts/upfront/upfront-views-editor/sidebar/commands/sidebar-commands-primary-post-type","scripts/upfront/upfront-views-editor/breakpoint","scripts/upfront/upfront-views-editor/sidebar/sidebar-panel-responsive-section-typography","scripts/upfront/upfront-views-editor/commands/command-save-post"],function(i,t,s,o,a,r,d,l,m){var p=s.Commands.extend({className:function(){var e="sidebar-commands sidebar-commands-control",n=Upfront.plugins.call("add-sidebar-commands-class",{className:e});return n.status&&"called"===n.status&&n.result&&(e=n.result),e},initialize:function(){Upfront.Application.user_can_modify_layout()?!1===Upfront.plugins.isForbiddenByPlugin("show undo redo and responsive commands")?(this.commands=_([new s.Command_Undo({model:this.model}),new s.Command_Redo({model:this.model})]),Upfront.Application.user_can("RESPONSIVE_MODE")&&this.commands.push(new s.Command_StartResponsiveMode({model:this.model})),this.commands.push(new s.Command_ToggleGrid({model:this.model}))):this.commands=_([new s.Command_ToggleGrid({model:this.model})]):this.commands=_([]),Upfront.Application.user_can("RESPONSIVE_MODE")&&Upfront.plugins.call("insert-responsive-buttons",{commands:this.commands,model:this.model}),Upfront.plugins.call("insert-save-buttons",{commands:this.commands,model:this.model}),this.commands.push(new s.Command_Trash({model:this.model})),!Upfront.Settings.Application.NO_SAVE&&!1===Upfront.plugins.isForbiddenByPlugin("show save layout command")&&Upfront.Application.user_can_modify_layout()?this.commands.push(new s.Command_SaveLayout({model:this.model})):!Upfront.Settings.Application.NO_SAVE&&!1===Upfront.plugins.isForbiddenByPlugin("show save layout command")&&Upfront.Application.user_can_save_content()?this.commands.push(new m({model:this.model})):!1===Upfront.plugins.isForbiddenByPlugin("show preview layout command")&&Upfront.Settings.Application.PERMS.REVISIONS&&this.commands.push(new s.Command_PreviewLayout({model:this.model})),Upfront.Settings.Debug.dev&&(Upfront.Settings.Application.NO_SAVE||!1!==Upfront.plugins.isForbiddenByPlugin("show reset everything command")||this.commands.push(new s.Command_ResetEverything({model:this.model})),Upfront.Settings.Application.DEBUG||!1!==Upfront.plugins.isForbiddenByPlugin("show publish layout command")||Upfront.Settings.Application.NO_SAVE||this.commands.push(new s.Command_PublishLayout({model:this.model})))}}),c=s.Commands.extend({className:"sidebar-commands sidebar-commands-header",initialize:function(){this.commands=_([new s.Command_Logo({model:this.model})]),this.commands.push(new s.Command_Menu({model:this.model})),this.listenTo(Upfront.Events,"upfront:more_menu:open",this.on_menu_open),this.listenTo(Upfront.Events,"upfront:more_menu:close",this.on_menu_close)},on_menu_open:function(){this.$el.addClass("more-menu-open clearfix")},on_menu_close:function(){this.$el.removeClass("more-menu-open clearfix")}}),h=Backbone.View.extend({tagName:"li",className:"sidebar-panel sidebar-panel-settings expanded",template:'<div class="sidebar-panel-content"></div>',initialize:function(){this.collection=d.storage.get_breakpoints(),this.listenTo(this.collection,"change:active",this.render),this.global_option=!0},render:function(){var e=d.storage.get_breakpoints().get_active();e.get("default")&&(this.model.attributes.id="default");var n=new l({model:e.get("default")?this.model:e});n.render(),this.$el.html(this.template),this.$el.find(".sidebar-panel-content").html(n.el)}}),u=Backbone.View.extend({tagName:"ul",className:"sidebar-commands sidebar-commands-responsive",initialize:function(){this.views=[new s.Command_BreakpointDropdown,new s.Command_AddCustomBreakpoint],this.views.push(new h({model:this.model}))},render:function(){return Upfront.Application.user_can_modify_layout()?(_.each(this.views,function(e){e.render(),"undefined"!=typeof e.global_option&&e.global_option?Upfront.Settings.Application.PERMS.OPTIONS&&this.$el.append(e.el):this.$el.append(e.el)},this),this):!1},destroy:function(){this.remove(),_.each(this.views,function(e){e.remove()})}}),g=s.Commands.extend({className:"sidebar-commands sidebar-commands-responsive-control sidebar-commands-control",initialize:function(){Upfront.Application.user_can_modify_layout()?this.commands=_([new s.Command_ResponsiveUndo({model:this.model}),new s.Command_ResponsiveRedo({model:this.model}),new s.Command_ToggleGrid({model:this.model}),new s.Command_SaveLayout,new s.Command_StopResponsiveMode]):this.commands=_([new s.Command_StopResponsiveMode])},render:function(){this.$el.find("li").remove(),this.commands.each(this.add_command,this)}}),f=Backbone.View.extend({tagName:"div",visible:1,events:{"click #sidebar-ui-toggler-handle":"toggleSidebar"},initialize:function(){this.sidebar_profile=new o({model:this.model}),this.sidebar_commands={header:new c({model:this.model}),primary:new r({model:this.model}),additional:!1,control:new p({model:this.model}),responsive:new u({model:this.model})},this.sidebar_panels=new a({model:this.model}),this.fetch_current_user(),Upfront.Application.get_current()!=Upfront.Settings.Application.MODE.CONTENT&&(Upfront.Events.on("upfront:element:edit:start",this.preventUsage,this),Upfront.Events.on("upfront:element:edit:stop",this.allowUsage,this),Upfront.Events.on("element:settings:deactivate",this.allowUsage,this),Upfront.Events.on("element:settings:canceled",this.allowUsage,this)),Upfront.Events.on("application:mode:after_switch",this.render,this),Upfront.Events.on("application:user:fetch",this.render,this)},preventUsage:function(i){var t=n.not_available_in_text_edit;"media-upload"===i&&(t=n.not_available_in_media_upload),"write"===i&&(this.writingIsOn=!0,t=n.publish_first_nag),this.prevented_usage_type||(this.prevented_usage_type=i),e("#preventUsageOverlay span").html(t),e("#preventUsageOverlay").show(),e("#preventElementsUsageOverlay span").html(t),e("#preventElementsUsageOverlay").show()},allowUsage:function(n){return this.writingIsOn&&"write"!==n?void this.preventUsage("write"):(this.prevented_usage_type=!1,this.writingIsOn=!1,e("#preventUsageOverlay").hide(),void e("#preventElementsUsageOverlay").hide())},render:function(){var n=Upfront.Application.get_current(),i=n===Upfront.Settings.Application.MODE.RESPONSIVE,t=e('<div id="sidebar-ui-wrapper" class="upfront-ui"></div>');if(Upfront.Events.trigger("sidebar:add_classes",t),this.sidebar_commands.header.render(),t.append(this.sidebar_commands.header.el),!1!==Upfront.plugins.isForbiddenByPlugin("show sidebar profile")||i||(this.sidebar_profile.render(),t.append(this.sidebar_profile.el)),i||(this.sidebar_commands.primary.render(),t.append(this.sidebar_commands.primary.el)),this.sidebar_commands.additional&&!i&&(this.sidebar_commands.additional.render(),t.append(this.sidebar_commands.additional.el)),i&&(this.sidebar_commands.responsive.render(),t.append(this.sidebar_commands.responsive.el)),n===Upfront.Settings.Application.MODE.CONTENT||i){if(i){var s=new g({model:this.model});s.render(),t.append(s.el)}}else this.sidebar_panels.render(),t.append(this.sidebar_panels.el),this.sidebar_commands.control.render(),t.append(this.sidebar_commands.control.el),t.append('<div id="preventUsageOverlay"><span></span></div>');this.$el.html(t),Upfront.Events.trigger("sidebar:rendered")},get_panel:function(e){return this.sidebar_panels.panels[e]?this.sidebar_panels.panels[e]:!1},get_commands:function(e){return this.sidebar_commands[e]?this.sidebar_commands[e]:!1},to_content_editor:function(){},from_content_editor:function(){},fetch_current_user:function(){var e=Upfront.data.currentUser;e||(e=new Upfront.Models.User,Upfront.data.loading.currentUser=e.fetch().done(function(){Upfront.data.currentUser=e,Upfront.Events.trigger("application:user:fetch")}))},addCollapsibleEvents:function(){var n=this;this.$el.append('<div id="sidebar-ui-toggler"><div id="sidebar-ui-toggler-handle" class="sidebar-ui-hide"></div></div>'),e("body").on("mousemove",function(i){300*n.visible+100>i.pageX?n.collapsibleHint||(e("#sidebar-ui-toggler").fadeIn(),n.collapsibleHint=!0):n.collapsibleHint&&(e("#sidebar-ui-toggler").fadeOut(),n.collapsibleHint=!1)}),this.resizeCollapseHandle(),e(window).on("resize",function(){n.resizeCollapseHandle()})},resizeCollapseHandle:function(){var n=e(window).height();this.$("#sidebar-ui-toggler").height(n)},toggleSidebar:function(n){var i=this,t={marginLeft:"260px"};unmargined_css={marginLeft:"0px"},_margin=Upfront.Util.isRTL()?"marginRight":"marginLeft",this.visible?(e("#sidebar-ui, #element-settings-sidebar").stop().animate({width:"0px"},300,function(){e("#sidebar-ui, #element-settings-sidebar").addClass("collapsed")}),Upfront.Util.isRTL()&&(unmargined_css={marginRight:"0px"}),e("#page").stop().animate(unmargined_css,300,function(){Upfront.Events.trigger("sidebar:toggle:done",i.visible)}),this.$("#sidebar-ui-toggler-handle").removeClass().addClass("sidebar-ui-show"),this.visible=0):(Upfront.Util.isRTL()&&(t={marginRight:"260px"}),e("#sidebar-ui").removeClass("collapsed").stop().animate({width:"260px"},300),e("#element-settings-sidebar").removeClass("collapsed"),0!==e("#element-settings-sidebar").contents().length&&e("#element-settings-sidebar").removeClass("collapsed").stop().animate({width:"260px"},300),e("#page").stop().animate(t,300,function(){Upfront.Events.trigger("sidebar:toggle:done",i.visible)}),this.$("#sidebar-ui-toggler-handle").removeClass().addClass("sidebar-ui-hide"),this.visible=1),Upfront.Events.trigger("sidebar:toggle",this.visible)}});return{Sidebar:f,Panel:i,Element:t}})}(jQuery);