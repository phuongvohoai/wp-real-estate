!function(e){var o=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/sidebar/sidebar-panel-settings-item","scripts/upfront/upfront-views-editor/theme-colors","scripts/upfront/upfront-views-editor/fields","text!upfront/templates/sidebar_settings_theme_colors.html"],function(t,r,n,s){return t.extend({initialize:function(){this.template=_.template(s),Upfront.Events.off("command:layout:save",this.on_save),Upfront.Events.off("command:layout:save_as",this.on_save),Upfront.Events.on("command:layout:save",this.on_save,this),Upfront.Events.on("command:layout:save_as",this.on_save,this),Upfront.Settings.Application.NO_SAVE&&Upfront.Events.on("preview:build:start",this.on_save,this),this.update_styles(),r.colors.bind("change reset add",this.update_styles,this)},events:{"change .panel-setting-theme-colors-shades-range":"change_range","click .theme-colors-color-box":"select_variation"},on_save:function(){var e={action:"upfront_update_theme_colors",theme_colors:r.colors.toJSON(),range:r.range};Upfront.Util.post(e).error(function(){return notifier.addMessage(o.theme_colors_save_fail)});var t={action:"upfront_save_theme_colors_styles",styles:this.styles};Upfront.Util.post(t).error(function(){return notifier.addMessage(o.theme_color_style_save_fail)})},update_styles:function(){this.styles="";var o=this;r.colors.each(function(e,t){var r="#000000"===e.get("color")&&0==e.get("alpha")?"inherit":e.get("color");o.styles+=" .upfront_theme_color_"+t+"{ color: "+r+";}",o.styles+=" a .upfront_theme_color_"+t+":hover{ color: "+e.get_hover_color()+";}",o.styles+=" button .upfront_theme_color_"+t+":hover{ color: "+e.get_hover_color()+";}",o.styles+=" .upfront_theme_bg_color_"+t+"{ background-color: "+r+";}",o.styles+=" a .upfront_theme_bg_color_"+t+":hover{ background-color: "+e.get_hover_color()+";}",o.styles+=" button .upfront_theme_bg_color_"+t+":hover{ background-color: "+e.get_hover_color()+";}",Upfront.Util.colors.update_colors_in_dom(e.get("prev"),r,t)}),e("#upfront_theme_colors_dom_styles").remove(),e("<style id='upfront_theme_colors_dom_styles' type='text/css'>"+this.styles+"</style>").appendTo("body"),Upfront.Events.trigger("theme_colors:update")},on_render:function(){var e;for(this.theme_colors=r,this.theme_color_range=r.range,this.$el.html(this.template({colors:this.theme_colors.colors.toJSON(),range:r.range})),this.add_previous_pickers(),e=this.theme_colors.colors.length;10>e;)this.add_unset_color(e),e++;this.add_slider()},add_empty_picker:function(e){var o=this,t=new n.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch theme_color_swatch_empty",hide_label:!0,default_value:"#ffffff",blank_alpha:0,spectrum:{choose:function(r){if(!_.isObject(r))return!1;var n=t.get_value();n&&"undefined"!=typeof tinycolor&&(r=tinycolor(n)),o.add_new_color(r,e)},change:function(e){return _.isObject(e)?void t.update_input_val(e.toHexString()):!1}}});t.render(),this.$(".theme_colors_empty_picker").html(t.$el).prepend('<span class="theme-colors-color-name">ufc'+e+"</span>")},add_unset_color:function(e){var o=this,t=new n.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch",hide_label:!0,default_value:"#ffffff",blank_alpha:0,spectrum:{choose:function(r){if(!_.isObject(r))return!1;var n=t.get_value();n&&"undefined"!=typeof tinycolor&&(r=tinycolor(n)),o.add_new_color(r,e)},change:function(r){return _.isObject(r)?(t.update_input_val(r.toHexString()),void(o.theme_colors.colors.at(e)?o.update_colors(this,r,e):(o.add_new_color(r,e),o.update_colors(this,r,e)))):!1}}});t.render(),t.$(".sp-preview").addClass("uf-unset-color"),this.$("#theme-colors-swatches").append(t.$el),t.$el.wrap('<span class="theme-colors-color-picker color-index">'.replace("index",e)),t.$el.closest(".theme-colors-color-picker").prepend('<span class="theme-colors-color-name">ufcindex</span>'.replace("index",e))},add_previous_pickers:function(){var o=this;this.$(".theme-colors-color-picker").each(function(t){var r=e(this),s=r.data("color"),a=o.theme_colors.colors.at(t),l=new n.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch",hide_label:!0,default_value:s,blank_alpha:0,spectrum:{change:function(e){o.update_colors(this,e,t)},move:function(e){l.$(".sp-preview").css({backgroundColor:e.toRgbString(),backgroundImage:"none"})},hide:function(e){l.$(".sp-preview").css({backgroundColor:e.toRgbString(),backgroundImage:"none"})}}});l.render(),l.$(".sp-preview").css({backgroundColor:s,backgroundImage:"none"}),"#000000"===a.get("color")&&0==a.get("alpha")?l.$(".sp-preview").addClass("uf-unset-color"):l.$(".sp-preview").removeClass("uf-unset-color"),r.html(l.$el),r.prepend('<span class="theme-colors-color-name">ufc'+t+"</span>")})},add_new_color:function(o,t){for(var s=parseInt(r.range,10)/100||0,a=this.theme_colors.colors.length;t>a;a++)this.theme_colors.colors.push({color:"#000000",prev:"#000000",highlight:"#000000",shade:"#000000",alpha:0});var l=this,c=this.theme_colors.colors.add({color:o.toHexString(),prev:o.toHexString(),highlight:l.color_luminance(o.toHex(),s),shade:l.color_luminance(o.toHex(),-1*s),alpha:o.alpha}),i=new n.Color({className:"upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch theme-colors-color-picker",hide_label:!0,default_value:o.toRgbString(),blank_alpha:0,change:function(o){var t=parseInt(r.range,10)/100||0;o=tinycolor(o),c.set({color:o.toHexString(),highlight:l.color_luminance(o.toHex(),t),shade:l.color_luminance(o.toHex(),-1*t),alpha:o.alpha}),e(this).parent().find(".sp-preview").css({backgroundColor:o.toRgbString(),backgroundImage:"none"}),this.default_value=o.toRgbString(),l.render_bottom()}}),p=r.colors.length-1,h=e('<span class="theme-colors-color-picker color-'+p+'" data-index="'+p+'" data-color="'+o.toHexString()+'"><span class="theme-colors-color-name">ufc'+p+"</span></span>");i.render(),i.$(".sp-preview").css({backgroundColor:o.toRgbString(),backgroundImage:"none"}),"#000000"===o.toHexString()&&0==o.alpha?i.$(".sp-preview").addClass("uf-unset-color"):i.$(".sp-preview").removeClass("uf-unset-color"),h.append(i.$el),this.$("#theme-colors-no-color-notice").hide(),this.render_bottom(),this.on_save()},render_bottom:function(){},color_luminance:function(e,o){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),o=o||0;var t,r,n="#";for(r=0;3>r;r++)t=parseInt(e.substr(2*r,2),16),t=Math.round(Math.min(Math.max(0,t+t*o),255)).toString(16),n+=("00"+t).substr(t.length);return n},change_range:function(e){var o=this;r.range=e,percentage=parseInt(e,10)/100||0,r.colors.each(function(e){var t=e.get("color");e.set("highlight",o.color_luminance(t,percentage)),e.set("shade",o.color_luminance(t,-1*percentage))}),this.render_bottom()},select_variation:function(o){var t=this,n=e(o.target),s=n.data("type"),a=n.data("index"),l=n.data("color"),c=r.colors.at(a);c.get("selected")?(c.set("selected",""),c.set("luminance",t.luminance(l))):(c.set("selected",s),c.set("luminance",t.luminance(l))),this.render_bottom()},luminance:function(e){e=e.substring(1);var o=parseInt(e,16),t=o>>16&255,r=o>>8&255,n=o>>0&255,s=.2126*t+.7152*r+.0722*n;return 80>s?"dark":"light"},add_slider:function(){var e=this;this.$(".panel-setting-theme-colors-shades-range").slider({value:r.range,min:0,max:50,change:function(o,t){e.change_range(t.value)}})},update_colors:function(o,t,n){var s=r.colors.at(n),a=parseInt(r.range,10)/100||0;s&&(s.set({color:t.toHexString(),prev:s.get("color"),highlight:this.color_luminance(t.toHex(),a),shade:this.color_luminance(t.toHex(),-1*a),alpha:t.alpha}),e(o).parent().find(".sp-preview").css({backgroundColor:t.toRgbString(),backgroundImage:"none"}),"#000000"===t.toHexString()&&0==t.alpha?e(o).parent().find(".sp-preview").addClass("uf-unset-color"):e(o).parent().find(".sp-preview").removeClass("uf-unset-color"),o.default_value=t.toRgbString(),this.render_bottom())}})})}(jQuery);