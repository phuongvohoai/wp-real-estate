!function(e){define(["scripts/upfront/link-model","text!scripts/upfront/templates/link-panel.html"],function(t,n){var l=function(){var e,t=Upfront.Application.layout.get("regions"),n=[{id:"#page",label:Upfront.Settings.l10n.global.views.back_to_top}];return e=function(t){t.each(function(t){var l=t.get_property_value_by_name("anchor");l&&l.length&&n.push({id:"#"+l,label:l}),t.get("objects")&&(t.get("objects")||{}).each?t.get("objects").each(function(e){var t=e.get_property_value_by_name("anchor");t&&t.length&&n.push({id:"#"+t,label:t})}):t.get("modules")&&e(t.get("modules"))})},t.each(function(t){e(t.get("modules"))}),n},i=function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){"attachment"!=t.name&&e.push({name:t.name,label:t.label})}),e},o=function(){var e=[],t=(Upfront.Application.layout||{}).get?Upfront.Application.layout.get("regions"):[];return _.each(t.models,function(t){"lightbox"==t.attributes.sub&&e.push({id:"#"+t.get("name"),label:t.get("title")})}),e},a=Backbone.View.extend({tpl:_.template(n),defaultLinkTypes:{unlink:!0,external:!0,entry:!0,anchor:!0,image:!1,lightbox:!0,email:!0,phone:!0,homepage:!0},events:{"click .js-ulinkpanel-input-entry":"openPostSelector","keydown .js-ulinkpanel-lightbox-input":"onLightboxNameInputChange","blur .js-ulinkpanel-input-external":"onUrlInputBlur","click .upfront-save_settings":"onOkClick","keydown .js-ulinkpanel-input-url.js-ulinkpanel-input-external":"onExternalUrlKeydown","click .link-panel-lightbox-trigger":"visit_lightbox"},className:"ulinkpanel-dark",visit_lightbox:function(t){t.preventDefault();var n=e(t.target).attr("href");if(n&&""!==n){var l=Upfront.Application.layout.get("regions");if(region=l?l.get_by_name(this.getUrlanchor(n)):!1,region){_.each(l.models,function(e){"lightbox"==e.attributes.sub&&Upfront.data.region_views[e.cid].hide()});var i=Upfront.data.region_views[region.cid];i.show()}}},getUrlanchor:function(t){if("undefined"==typeof t&&(t=e(location).attr("href")),t.indexOf("#")>=0){var n=t.split("#");return n[1]}return!1},initialize:function(e){if(e.linkTypes&&e.linkTypes.image&&e.linkTypes.image===!0&&_.isUndefined(e.imageUrl))throw'Provide "imageUrl" if "linkTypes" option has { image: true } when initializing LinkPanel.';if(this.options=e||{},this.linkTypes=_.extend({},this.defaultLinkTypes,e.linkTypes||{}),this.theme=e.theme||"dark",this.button=e.button||!1,this.title=e.title||Upfront.Settings.l10n.global.content.links_to,"undefined"==typeof e.model)return void Upfront.Util.log("There was no link model, use new linking.");var t=document.location.origin+document.location.pathname;"anchor"===this.model.get("type")&&null!==this.model.get("url").match(/^#/)&&this.model.set({url:t+this.model.get("url")},{silent:!0}),this.listenTo(this.model,"change:type",this.handleTypeChange)},onOkClick:function(){"lightbox"==this.model.get("type")&&""!==this.$el.find(".js-ulinkpanel-lightbox-input").val()?this.createLightBox():(this.close(),this.model.trigger("change"))},onExternalUrlKeydown:function(e){return 13!==e.which?!0:(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),this.onOkClick(e),this.trigger("url:changed"),!1)},close:function(){this.trigger("linkpanel:close")},handleTypeChange:function(){"homepage"===this.model.get("type")?this.model.set({url:Upfront.mainData.site},{silent:!0}):this.model.set({url:""},{silent:!0}),this.render(),"entry"===this.model.get("type")&&this.openPostSelector(),"image"===this.model.get("type")&&this.model.set({url:this.options.imageUrl})},getLinkTypeValue:function(e){var t=Upfront.Settings.l10n.global.content;switch(e){case"homepage":return{value:"homepage",label:t.homepage};case"unlink":return{value:"unlink",label:t.no_link};case"external":return{value:"external",label:t.url};case"email":return{value:"email",label:t.email};case"phone":return{value:"phone",label:t.phone};case"entry":return{value:"entry",label:t.post_or_page};case"anchor":return{value:"anchor",label:t.anchor};case"image":return{value:"image",label:t.larger_image};case"lightbox":return{value:"lightbox",label:t.lightbox}}},openPostSelector:function(e){e&&e.preventDefault();var t=this,n={postTypes:i()};Upfront.Views.Editor.PostSelector.open(n).done(function(e){t.model.set({url:e.get("permalink"),object:e.get("post_type"),object_id:e.get("ID")}),t.render()})},onLightboxNameInputChange:function(e){13==e.which&&(e.preventDefault(),this.createLightBox())},createLightBox:function(){var t=e.trim(this.$(".js-ulinkpanel-lightbox-input").val());return t?(this.model.set({url:"#"+Upfront.Application.LayoutEditor.getLightboxSafeName(t)}),Upfront.Application.LayoutEditor.createLightboxRegion(t),this.model.trigger("change",!0),void this.render()):(Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.views.ltbox_empty_name_nag,"error"),!1)},onUrlInputBlur:function(t){var n=e(t.currentTarget).val().trim();"external"!==this.model.get("type")||n.match(/https?:\/\//)||_.isEmpty(n)||(n="http://"+n),"email"!==this.model.get("type")||n.match(/^mailto:/)||(n="mailto:"+n),"phone"!==this.model.get("type")||n.match(/^tel:/)||(n="tel:"+n,this.model.set({target:"_self"})),this.model.set({url:n}),this.render()},render:function(){if(!this.model)return void this.$el.html("Error occurred, link panel switch to new style.");var e={title:this.title,link:this.model.toJSON(),checked:'checked="checked"',lightboxes:o(),button:this.button,type:this.model.get("type")};this.$el.html(this.tpl(e)),this.renderTypeSelect(),"anchor"==this.model.get("type")&&this.renderAnchorSelect(),"lightbox"==this.model.get("type")&&o()&&this.renderLightBoxesSelect(),_.contains(["external","entry","homepage"],this.model.get("type"))&&this.renderTargetRadio(),this.delegateEvents()},renderTypeSelect:function(){var e=this,t=[];_.each(this.linkTypes,function(e,n){e&&t.push(this.getLinkTypeValue(n))},this),this.typeSelect=new Upfront.Views.Editor.Field.Select({label:"",values:t,default_value:this.model.get("type"),change:function(){e.model.set({type:this.get_value()})}}),this.typeSelect.render(),this.$el.find("form").prepend(this.typeSelect.el)},renderTargetRadio:function(){var e=this;this.targetRadio=new Upfront.Views.Editor.Field.Radios({label:Upfront.Settings.l10n.global.content.target,default_value:this.model.get("target")||"_self",layout:"horizontal-inline",values:[{label:Upfront.Settings.l10n.global.content.blank,value:"_blank"},{label:Upfront.Settings.l10n.global.content.self,value:"_self"}],change:function(){e.model.set({target:this.get_value()})}}),this.targetRadio.render(),this.$el.find("form").append(this.targetRadio.el)},renderAnchorSelect:function(){var e=this.model,t=document.location.origin+document.location.pathname,n=[{label:"Choose Anchor...",value:""}];_.each(l(),function(e){n.push({label:e.label,value:t+e.id})});var i=this.model.get("url");i=i?i:"",i=-1!==i.indexOf("#")?i:"",this.anchorSelect=new Upfront.Views.Editor.Field.Select({label:"",values:n,default_value:i,change:function(){var t=this.get_value();null!==document.location.pathname.match(/^\/create_new\//)&&(t="#"+t.split("#")[1]),e.set({url:t})}}),this.anchorSelect.render(),this.$el.find(".anchor-selector").append(this.anchorSelect.el)},renderLightBoxesSelect:function(){var t=this.model,n=[{label:"Choose Lightbox...",value:""}];_.each(o()||[],function(e){n.push({label:e.label,value:e.id})});var l=this.model.get("url");l=l?l:"",l=l.match(/^#/)?l:"",this.lightboxSelect=new Upfront.Views.Editor.Field.Select({label:"",values:n,default_value:l,change:function(){t.set({url:this.get_value()}),e(".link-panel-lightbox-trigger").attr("href",this.get_value())}}),this.lightboxSelect.render(),this.$el.find(".lightbox-selector").append(this.lightboxSelect.el)},delegateEvents:function(e){this.typeSelect&&this.typeSelect.delegateEvents(),this.anchorSelect&&this.anchorSelect.delegateEvents(),this.lightboxSelect&&this.lightboxSelect.delegateEvents(),Backbone.View.prototype.delegateEvents.call(this,e)}});return a})}(jQuery);